<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui">

    <p:dialog header="#{goalFormDialog.name}" widgetVar="goalFormDialogWidget"
              modal="true" id="goalFormDialog" resizable="false" draggable="false"
              width="750">
        <h:form id="goalForm">
            <!-- FIX: Wrapped all content in a single PanelGrid to correctly hold the footer facet -->
            <p:panelGrid columns="1" styleClass="ui-panelgrid-blank" style="width: 100%;">

                <!-- This inner grid keeps your original two-column layout for the main fields -->
                <p:panelGrid columns="2" styleClass="ui-panelgrid-blank" style="width: 100%;">
                    <p:outputLabel for="title" value="Title:" />
                    <p:inputText id="title" value="#{goalFormDialog.model.title}" required="true" style="width: 100%;"/>

                    <p:outputLabel for="weight" value="Goal Weight (%):" />
                    <p:inputNumber id="weight" value="#{goalFormDialog.model.weight}" required="true"
                                   minValue="1" maxValue="100" decimalPlaces="0" />

                    <!-- =================== FIX START =================== -->
                    <!-- Replaced the dropdown with a read-only display to prevent changing the parent -->
                    <p:outputLabel for="parentGoalDisplay" value="Parent Goal:" rendered="#{goalFormDialog.model.goalLevel != 'ORGANISATIONAL' and goalFormDialog.model.parentGoal != null}" />
                    <h:panelGroup rendered="#{goalFormDialog.model.goalLevel != 'ORGANISATIONAL' and goalFormDialog.model.parentGoal != null}">
                        <h:outputText id="parentGoalDisplay" value="#{goalFormDialog.model.parentGoal.title}" style="font-weight: bold;" />
                        <h:inputHidden value="#{goalFormDialog.model.parentGoal}" converter="goalConverter" />
                    </h:panelGroup>

                    <!-- Replaced disabled inputText with outputText and a hidden input to ensure value submission -->
                    <p:outputLabel for="departmentDisplay" value="Department:" rendered="#{goalFormDialog.model.goalLevel == 'DEPARTMENT'}" />
                    <h:panelGroup rendered="#{goalFormDialog.model.goalLevel == 'DEPARTMENT'}">
                        <h:outputText id="departmentDisplay" value="#{goalFormDialog.model.department.name}" style="font-weight: bold;" />
                        <h:inputHidden value="#{goalFormDialog.model.department}" converter="departmentConverter" />
                    </h:panelGroup>
                    <!-- =================== FIX END ===================== -->

                    <p:outputLabel for="teamDisplay" value="Team:" rendered="#{goalFormDialog.model.goalLevel == 'TEAM'}" />
                    <h:panelGroup rendered="#{goalFormDialog.model.goalLevel == 'TEAM'}">
                        <h:outputText id="teamDisplay" value="#{goalFormDialog.model.team.name}" style="font-weight: bold;" />
                        <h:inputHidden value="#{goalFormDialog.model.team}" converter="teamConverter" />
                    </h:panelGroup>

                    <p:outputLabel for="targetDate" value="Target Date:" />
                    <p:calendar id="targetDate" value="#{goalFormDialog.model.targetDate}" pattern="dd/MM/yyyy" required="true" />

                    <p:outputLabel for="description" value="Description:" />
                    <p:inputTextarea id="description" value="#{goalFormDialog.model.description}" rows="4" style="width: 100%;"/>
                </p:panelGrid>

                <!-- Department Assignments for Organisational Goals -->
                <p:panel header="Department Contributions" style="margin-top: 20px;"
                         rendered="#{goalFormDialog.model.goalLevel == 'ORGANISATIONAL'}">
                    <p:dataTable id="deptAssignmentsTable" value="#{goalFormDialog.departmentAssignments}" var="assignment">
                        <p:column headerText="Department">
                            <p:selectOneMenu value="#{assignment.department}" converter="departmentConverter" required="true" style="width: 100%;">
                                <f:selectItem itemLabel="Select Department" itemValue="#{null}" noSelectionOption="true"/>
                                <f:selectItems value="#{goalFormDialog.allDepartments}" var="dept"
                                               itemLabel="#{dept.name}" itemValue="#{dept}"/>
                            </p:selectOneMenu>
                        </p:column>
                        <p:column headerText="Contribution Weight (%)" style="width: 200px;">
                            <p:inputNumber value="#{assignment.contributionWeight}" required="true" minValue="1" maxValue="100" decimalPlaces="0"/>
                        </p:column>
                        <p:column style="width: 50px;">
                            <p:commandButton icon="pi pi-trash" styleClass="ui-button-danger"
                                             actionListener="#{goalFormDialog.removeDepartmentAssignment(assignment)}"
                                             update="deptAssignmentsTable" process="@this"/>
                        </p:column>
                    </p:dataTable>
                    <p:commandButton value="Add Department" icon="pi pi-plus"
                                     actionListener="#{goalFormDialog.addDepartmentAssignment()}"
                                     update="deptAssignmentsTable" process="@this" style="margin-top: 10px;"/>
                </p:panel>

                <!-- FIX: Moved the footer to be a child of the main panelGrid and made the update dynamic -->
                <f:facet name="footer">
                    <div class="p-d-flex p-jc-end">
                        <p:commandButton value="Save" actionListener="#{goalFormDialog.save}"
                                         update="#{goalFormDialog.updateTarget} :growl"
                                         oncomplete="if(!args.validationFailed) PF('goalFormDialogWidget').hide()" />
                        <p:commandButton value="Cancel" oncomplete="PF('goalFormDialogWidget').hide()" immediate="true" process="@this"
                                         styleClass="ui-button-secondary" style="margin-left: .5em;"/>
                    </div>
                </f:facet>
            </p:panelGrid>
        </h:form>
    </p:dialog>
</ui:composition>