<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                template="/pages/californiatemplate/template.xhtml">

    <f:metadata>
        <f:viewParam name="userId" value="#{userProfileView.userId}"/>
        <f:viewAction action="#{userProfileView.loadUser}"/>
    </f:metadata>

    <ui:define name="title">
        <h:outputText value="#{userProfileView.selectedUser.fullName}'s Profile" rendered="#{userProfileView.selectedUser != null}"/>
        <h:outputText value="User Not Found" rendered="#{userProfileView.selectedUser == null}"/>
    </ui:define>

    <ui:define name="content">
        <div class="card">
            <h:form id="userProfileForm">
                <p:panel rendered="#{userProfileView.selectedUser != null}">
                    <f:facet name="header">
                        <div class="p-d-flex p-jc-between p-ai-center">
                            <h:outputText value="#{userProfileView.selectedUser.fullName}'s Profile" style="font-size: 1.5rem; font-weight: bold;"/>
                            <p:button outcome="/pages/users/UsersView.xhtml" value="Back to User List" icon="pi pi-arrow-left"/>
                        </div>
                    </f:facet>

                    <!-- User Details Panel -->
                    <p:panelGrid columns="2" layout="grid" styleClass="ui-panelgrid-blank" columnClasses="p-col-12 p-md-6, p-col-12 p-md-6">
                        <h:panelGroup>
                            <h:outputText value="Email: " styleClass="font-weight-bold d-block"/>
                            <h:outputText value="#{userProfileView.selectedUser.emailAddress}" />
                        </h:panelGroup>

                        <h:panelGroup>
                            <h:outputText value="Phone Number" styleClass="font-weight-bold d-block"/>
                            <h:outputText value="#{userProfileView.selectedUser.phoneNumber}" />
                        </h:panelGroup>

                        <h:panelGroup>
                            <h:outputText value="Designation" styleClass="font-weight-bold d-block"/>
                            <h:outputText value="#{userProfileView.selectedUser.designation}" />
                        </h:panelGroup>

                        <h:panelGroup>
                            <h:outputText value="Roles" styleClass="font-weight-bold d-block"/>
                            <ui:repeat value="#{userProfileView.selectedUser.roles.toArray()}" var="role" varStatus="status">
                                <h:outputText value="#{role.name}#{!status.last ? ', ' : ''}" />
                            </ui:repeat>
                        </h:panelGroup>
                    </p:panelGrid>

                    <hr/>

                    <!-- Performance Overview -->
                    <p:panel header="Performance Overview">
                        <p:panelGrid columns="2" layout="grid" styleClass="ui-panelgrid-blank">
                            <p:panel style="text-align: center;">
                                <h4 style="margin-top: 0;">Overall Performance</h4>
                                <p:knob value="75" min="0" max="100"
                                        thickness="0.2" width="150" height="150"
                                        fgColor="#4CAF50" lineCap="round" readonly="true"
                                        labelTemplate="{value}%"/>
                                <p class="p-mt-2">Based on completed KPIs</p>
                            </p:panel>
                            <!-- Add more performance metrics here -->
                        </p:panelGrid>
                    </p:panel>

                    <hr/>

                    <!-- Goals and Activities Tabs -->
                    <p:tabView>
                        <p:tab title="Assigned Goals">
                            <p:dataTable value="#{userProfileView.userGoals}" var="goal" emptyMessage="No goals assigned to this user's team.">
                                <p:column headerText="Goal Title" sortBy="#{goal.title}">
                                    <h:outputText value="#{goal.title}" />
                                </p:column>
                                <p:column headerText="Target Date" sortBy="#{goal.targetDate}" style="width: 150px;">
                                    <h:outputText value="#{goal.targetDate}">
                                        <f:convertDateTime pattern="dd MMM, yyyy"/>
                                    </h:outputText>
                                </p:column>
                                <p:column headerText="Status" style="width: 150px; text-align: center;">
                                    <p:tag value="#{goal.status.name}"
                                           styleClass="#{goal.status == 'COMPLETED' ? 'ui-tag-success' : (goal.status == 'IN_PROGRESS' ? 'ui-tag-warning' : 'ui-tag-info')}"/>
                                </p:column>
                            </p:dataTable>
                        </p:tab>

                        <p:tab title="Assigned Activities">
                            <p:dataTable value="#{userProfileView.userActivities}" var="activity" emptyMessage="No activities assigned to this user.">
                                <p:column headerText="Activity Title" sortBy="#{activity.title}">
                                    <h:outputText value="#{activity.title}" />
                                </p:column>
                                <p:column headerText="Parent Goal" sortBy="#{activity.goal.title}">
                                    <h:outputText value="#{activity.goal.title}" />
                                </p:column>
                                <p:column headerText="End Date" sortBy="#{activity.endDate}" style="width: 150px;">
                                    <h:outputText value="#{activity.endDate}">
                                        <f:convertDateTime pattern="dd MMM, yyyy"/>
                                    </h:outputText>
                                </p:column>
                                <p:column headerText="Status" style="width: 150px; text-align: center;">
                                    <p:tag value="#{activity.status.name}"
                                           styleClass="#{activity.status == 'COMPLETED' ? 'ui-tag-success' : (activity.status == 'ONGOING' ? 'ui-tag-warning' : 'ui-tag-info')}"/>
                                </p:column>
                            </p:dataTable>
                        </p:tab>
                    </p:tabView>
                </p:panel>

                <!-- Panel to show if user is not found -->
                <p:panel rendered="#{userProfileView.selectedUser == null}">
                    <div class="p-text-center">
                        <h3>User Not Found</h3>
                        <p>The requested user could not be found. Please return to the user list.</p>
                        <p:button outcome="/pages/users/UsersView.xhtml" value="Back to User List" icon="pi pi-arrow-left"/>
                    </div>
                </p:panel>
            </h:form>
        </div>
    </ui:define>
</ui:composition>