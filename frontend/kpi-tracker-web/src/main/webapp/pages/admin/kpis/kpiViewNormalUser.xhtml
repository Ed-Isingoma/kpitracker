<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                template="/pages/californiatemplate/template.xhtml">

    <ui:define name="title">
        My Goals and KPIs
    </ui:define>

    <ui:define name="content">
        <h:form id="userGoalsForm">
            <div class="card">
                <p:toolbar style="margin-bottom: 1rem;">
                    <p:toolbarGroup>
                        <h:outputText value="My Performance" style="font-size: 1.5rem; font-weight: bold;"/>
                    </p:toolbarGroup>

                    <p:toolbarGroup align="right">
                        <div class="p-d-flex p-ai-center p-flex-wrap">
                            <!-- NEW: Overall Achievement Score Display -->
                            <p:outputPanel id="overallAchievementPanel" styleClass="p-mr-3">
                                <span class="p-text-secondary">Overall Achievement: </span>
                                <span class="p-text-bold" style="font-size: 1.1rem;">
                                    <h:outputText value="#{kpiViewNormalUser.userOverallAchievement}">
                                        <f:convertNumber type="number" maxFractionDigits="1"/>
                                    </h:outputText>%
                                </span>
                            </p:outputPanel>
                            <!-- END: New Component -->

                            <p:outputLabel for="goalCycleFilter" value="Filter by Cycle:" style="margin-right: .5rem;"/>
                            <p:selectOneMenu id="goalCycleFilter" value="#{kpiViewNormalUser.selectedGoalCycle}"
                                             filter="true" filterMatchMode="contains" style="min-width: 18rem;">
                                <f:selectItems value="#{kpiViewNormalUser.allGoalCycles}" var="cycle"
                                               itemLabel="#{cycle.title}" itemValue="#{cycle}"/>
                                <f:converter converterId="omnifaces.SelectItemsConverter"/>
                                <p:ajax listener="#{kpiViewNormalUser.onCycleChange}" update=":userGoalsForm"/>
                            </p:selectOneMenu>
                        </div>
                    </p:toolbarGroup>
                </p:toolbar>

                <p:dataScroller id="goalsDataScroller" value="#{kpiViewNormalUser}" var="goal" chunkSize="5" lazy="true">
                    <f:facet name="header">
                        Your Assigned Goals
                    </f:facet>

                    <div class="p-panel p-component mb-3">
                        <div class="p-panel-header">
                            <span style="margin-bottom: 4px" class="p-panel-title flex align-items-center">
                                <p:tag value="#{goal.goalLevel}: "
                                       styleClass="mr-2"
                                       severity="#{goal.goalLevel == 'ORGANISATIONAL' ? 'success' : (goal.goalLevel == 'DEPARTMENT' ? 'info' : 'warning')}"/>
                                <span>#{goal.title}</span>
                            </span>
                            <div class="p-panel-icons">
                                <p:commandButton value="Add KPI" icon="pi pi-plus"
                                                 actionListener="#{kpiViewNormalUser.prepareNewKpi(goal)}"
                                                 oncomplete="PF('kpiDialogWidget').show()"
                                                 update=":kpiDialogContent" process="@this"
                                                 styleClass="ui-button-info ui-button-sm mr-2"/>

                                <p:commandButton value="Add Activity" icon="pi pi-plus"
                                                 actionListener="#{kpiViewNormalUser.prepareAndShowNewActivity(goal)}"
                                                 styleClass="ui-button-success ui-button-sm"
                                                 process="@this"
                                                 update=":kpiDialogContent">
                                    <p:ajax event="dialogReturn" listener="#{kpiViewNormalUser.onCycleChange}" update=":userGoalsForm:goalsDataScroller" />
                                </p:commandButton>
                            </div>
                        </div>
                        <div class="p-panel-content">
                            <p:tabView>
                                <p:tab title="Key Performance Indicators (#{kpiViewNormalUser.getKpisForGoal(goal).size()})">
                                    <p:dataTable var="kpi" value="#{kpiViewNormalUser.getKpisForGoal(goal)}"
                                                 emptyMessage="No KPIs have been set for this goal."
                                                 styleClass="p-datatable-sm">
                                        <p:column headerText="KPI Title" sortBy="#{kpi.title}">
                                            <h:outputText value="#{kpi.title}" />
                                        </p:column>
                                        <p:column headerText="Measure">
                                            <h:outputText value="#{kpi.measure}" />
                                        </p:column>
                                        <p:column headerText="Weight (%)" style="width: 8rem; text-align: center;">
                                            <h:outputText value="#{kpi.weight}%" />
                                        </p:column>

                                        <!-- UPDATED: Interactive Status Column -->
                                        <p:column headerText="Status" style="width: 8rem; text-align: center;">
                                            <p:selectBooleanCheckbox value="#{kpi.achieved}" title="Mark as Achieved/Not Achieved">
                                                <!-- This AJAX call saves the change and updates the overall score -->
                                                <p:ajax listener="#{kpiViewNormalUser.updateUserKpi(kpi)}"
                                                        update=":userGoalsForm:overallAchievementPanel" />
                                            </p:selectBooleanCheckbox>
                                        </p:column>
                                        <!-- END: Update -->

                                    </p:dataTable>
                                </p:tab>
                                <p:tab title="Activities (#{goal.activities.size()})">
                                    <!-- This section remains unchanged -->
                                    <p:dataTable var="activity" value="#{goal.activities}"
                                                 emptyMessage="No activities have been set for this goal."
                                                 styleClass="p-datatable-sm">
                                        <p:column headerText="Activity Title" sortBy="#{activity.title}">
                                            <h:outputText value="#{activity.title}" />
                                        </p:column>
                                        <p:column headerText="Assigned To" style="width: 10rem;">
                                            <h:outputText value="#{activity.assignedUser.username}" />
                                        </p:column>
                                    </p:dataTable>
                                </p:tab>
                            </p:tabView>
                        </div>
                    </div>
                </p:dataScroller>

                <p:outputPanel id="emptyMessagePanel" rendered="#{kpiViewNormalUser.totalRecords eq 0}" style="text-align: center; padding: 2rem;">
                    <i class="pi pi-info-circle" style="font-size: 2rem; color: #888;"> </i>
                    <p style="color: #555;">No goals are currently assigned to you for the selected cycle.</p>
                </p:outputPanel>

            </div>
        </h:form>

        <!-- Your existing dialogs -->
        <ui:include src="/pages/admin/kpis/_kpiDialog.xhtml"/>
        <!-- <ui:include src="/pages/admin/goals/activityFormEmployee.xhtml"/> -->

    </ui:define>

</ui:composition>