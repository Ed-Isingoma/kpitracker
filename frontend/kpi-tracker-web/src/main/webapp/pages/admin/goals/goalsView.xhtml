<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                template="/pages/californiatemplate/template.xhtml">

    <ui:define name="title">Goal Cycles</ui:define>

    <ui:define name="content">
        <h:form id="goalCyclesForm">
            <div class="card">
                <p:dataView id="cyclesDataView" value="#{goalsView.dataModels}"  var="cycle" layout="grid" lazy="true"
                            paginator="true" rows="#{goalsView.maximumresultsPerpage}" paginatorPosition="bottom"
                            gridIcon="pi pi-th-large" listIcon="pi pi-bars">

                    <f:facet name="header">
                        <div class="p-d-flex p-jc-between p-ai-center">
                            <span>Goal Cycles</span>
                            <p:commandButton value="New Cycle" icon="pi pi-plus"
                                             actionListener="#{goalsView.goalCycleFormDialog.resetModal}"
                                             oncomplete="PF('goalCycleFormDialogWidget').show()"
                                             update=":goalCycleFormDialog" process="@this"/>
                            <!-- NEW: Added a manual Refresh button for debugging -->
                            <p:commandButton value="Refresh" icon="pi pi-refresh"
                                             actionListener="#{goalsView.reloadFilterReset}"
                                             update="cyclesDataView" process="@this"/>
                        </div>
                    </f:facet>

                    <p:dataViewGridItem>
                        <div class="p-col-12 p-md-4">
                            <div class="card m-2">
                                <div class="p-d-flex p-flex-column">
                                    <div class="p-d-flex p-jc-between p-ai-start">
                                        <div class="p-d-flex p-flex-column">
                                            <span class="font-weight-bold" style="font-size: 1.2rem;">#{cycle.title}</span>
                                            <span class="text-secondary">
                                                <h:outputText value="#{cycle.startDate}">
                                                    <f:convertDateTime pattern="dd MMM yyyy"/>
                                                </h:outputText> -
                                                <h:outputText value="#{cycle.endDate}">
                                                    <f:convertDateTime pattern="dd MMM yyyy"/>
                                                </h:outputText>
                                            </span>
                                        </div>
                                        <p:tag value="#{cycle.status.name}"
                                               styleClass="#{cycle.status == 'COMPLETED' ? 'ui-tag-success' : (cycle.status == 'IN_PROGRESS' ? 'ui-tag-warning' : 'ui-tag-info')}"/>
                                    </div>
                                    <div class="p-d-flex p-jc-between p-mt-3">
                                        <p:button value="View Dashboard" icon="pi pi-arrow-right" iconPos="right"
                                                  styleClass="ui-button-outlined"
                                                  outcome="/pages/admin/goals/goalCycleView.xhtml?faces-redirect=true&amp;cycleId=#{cycle.id}"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </p:dataViewGridItem>
                </p:dataView>
            </div>
        </h:form>

        <!-- Include the dialog for creating a new cycle -->
        <ui:include src="goalCycleForm.xhtml"/>
    </ui:define>
</ui:composition>